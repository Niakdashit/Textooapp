<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Persistance S√©lection - Textoo Assist</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-area {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            min-height: 200px;
        }
        .instructions {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .test-text {
            line-height: 1.6;
            font-size: 16px;
        }
        .highlight {
            background: yellow;
            color: black;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
        }
        .success {
            background: rgba(76, 175, 80, 0.3);
        }
        .error {
            background: rgba(244, 67, 54, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Persistance S√©lection - Textoo Assist</h1>
        
        <div class="instructions">
            <h3>üìã Instructions de test :</h3>
            <ol>
                <li>S√©lectionnez du texte dans la zone de test ci-dessous</li>
                <li>Cliquez sur le bouton Textoo Assist (FAB) en bas √† droite</li>
                <li>V√©rifiez que la s√©lection reste active m√™me apr√®s le clic</li>
                <li>Testez les diff√©rentes actions du menu</li>
                <li>V√©rifiez que la s√©lection est pr√©serv√©e</li>
            </ol>
        </div>

        <div class="test-area" contenteditable="true">
            <div class="test-text">
                <p><strong>Texte de test pour la persistance de s√©lection :</strong></p>
                
                <p>S√©lectionnez ce paragraphe et testez la persistance de la s√©lection avec le bouton Textoo Assist. Le texte s√©lectionn√© devrait rester visible m√™me apr√®s avoir cliqu√© sur le bouton.</p>
                
                <p>Voici un autre paragraphe que vous pouvez s√©lectionner pour tester diff√©rentes longueurs de s√©lection. Essayez de s√©lectionner une partie de ce texte ou la totalit√©.</p>
                
                <p>Ce troisi√®me paragraphe contient des phrases plus courtes. Vous pouvez tester la s√©lection de mots individuels ou de phrases compl√®tes.</p>
                
                <p><em>Texte en italique</em> et <strong>texte en gras</strong> pour tester la persistance sur diff√©rents styles de texte.</p>
                
                <p>Dernier paragraphe avec des √©l√©ments sp√©ciaux comme des <span class="highlight">√©l√©ments surlign√©s</span> et des <a href="#">liens</a> pour tester la robustesse de la persistance de s√©lection.</p>
            </div>
        </div>

        <div class="status" id="status">
            <strong>Status :</strong> En attente de s√©lection de texte...
        </div>

        <div class="instructions">
            <h3>üîß Fonctionnalit√©s test√©es :</h3>
            <ul>
                <li>‚úÖ Capture de s√©lection au mousedown</li>
                <li>‚úÖ Pr√©vention de la perte de focus</li>
                <li>‚úÖ Restauration imm√©diate de la s√©lection</li>
                <li>‚úÖ Restauration apr√®s d√©lai de s√©curit√©</li>
                <li>‚úÖ Validation de la range de s√©lection</li>
                <li>‚úÖ Gestion des clics sur le menu</li>
            </ul>
        </div>
    </div>

    <script>
        // Simuler les fonctions de l'extension Textoo
        let lastSelectedText = '';
        let lastSelectionRange = null;
        
        function getSelectedText() {
            try {
                const sel = window.getSelection();
                if(sel && sel.rangeCount > 0) {
                    const range = sel.getRangeAt(0);
                    const selectedText = range.toString().trim();
                    
                    if(selectedText.length > 0) {
                        console.log('Texte s√©lectionn√© trouv√©:', selectedText);
                        lastSelectedText = selectedText;
                        lastSelectionRange = range.cloneRange();
                        
                        // V√©rifier que la range est valide
                        try {
                            lastSelectionRange.toString();
                            console.log('Range de s√©lection sauvegard√©e et valid√©e');
                        } catch(e) {
                            console.log('Range invalide, nettoyage:', e);
                            lastSelectionRange = null;
                        }
                        
                        updateStatus(`‚úÖ S√©lection captur√©e: "${selectedText}"`, 'success');
                        return selectedText;
                    }
                }
                
                updateStatus('‚ùå Aucun texte s√©lectionn√©', 'error');
                lastSelectedText = '';
                lastSelectionRange = null;
                return '';
            } catch(e) {
                console.error('Erreur lors de la r√©cup√©ration de la s√©lection:', e);
                updateStatus('‚ùå Erreur lors de la capture de s√©lection', 'error');
                lastSelectedText = '';
                lastSelectionRange = null;
                return '';
            }
        }
        
        function updateStatus(message, type = '') {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `<strong>Status :</strong> ${message}`;
            statusEl.className = `status ${type}`;
        }
        
        // Capturer la s√©lection en temps r√©el
        document.addEventListener('selectionchange', () => {
            const selectedText = getSelectedText();
            if(selectedText) {
                console.log('S√©lection d√©tect√©e:', selectedText);
            }
        });
        
        // Simuler le bouton FAB
        function createFAB() {
            const fab = document.createElement('button');
            fab.innerHTML = 'üìù';
            fab.style.cssText = `
                position: fixed;
                right: 18px;
                bottom: 18px;
                width: 44px;
                height: 44px;
                border-radius: 50%;
                border: none;
                background: #6c3ef0;
                color: white;
                font-size: 20px;
                cursor: pointer;
                z-index: 1000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            `;
            fab.title = 'Textoo Assist - Test Persistance';
            
            // Capturer au mousedown
            fab.addEventListener('mousedown', (e) => {
                const selectedText = getSelectedText();
                console.log('Texte captur√© au mousedown:', selectedText);
                e.preventDefault();
            });
            
            // Gestion du clic
            fab.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('Clic sur FAB d√©tect√©');
                
                // Restaurer la s√©lection
                if(lastSelectionRange) {
                    try {
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(lastSelectionRange);
                        console.log('S√©lection restaur√©e apr√®s clic');
                        updateStatus(`‚úÖ S√©lection restaur√©e: "${lastSelectedText}"`, 'success');
                    } catch(e) {
                        console.log('Impossible de restaurer la s√©lection:', e);
                        updateStatus('‚ùå Impossible de restaurer la s√©lection', 'error');
                    }
                    
                    // Restaurer aussi apr√®s d√©lai
                    setTimeout(() => {
                        try {
                            const sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(lastSelectionRange);
                            console.log('S√©lection restaur√©e apr√®s d√©lai');
                            updateStatus(`‚úÖ S√©lection maintenue: "${lastSelectedText}"`, 'success');
                        } catch(e) {
                            console.log('Impossible de restaurer la s√©lection apr√®s d√©lai:', e);
                            updateStatus('‚ùå S√©lection perdue apr√®s d√©lai', 'error');
                        }
                    }, 100);
                } else {
                    updateStatus('‚ùå Aucune s√©lection √† restaurer', 'error');
                }
            });
            
            document.body.appendChild(fab);
        }
        
        // Initialiser le test
        document.addEventListener('DOMContentLoaded', () => {
            createFAB();
            updateStatus('üß™ Test pr√™t - S√©lectionnez du texte et cliquez sur le bouton', '');
        });
    </script>
</body>
</html>
